<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>{{ note['title'] }} - Note</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      display: flex;
      background: #f4f6f9;
      color: #333;
    }

    .sidebar {
      width: 230px;
      background: linear-gradient(180deg, #2c3e50, #34495e);
      color: #ecf0f1;
      height: 100vh;
      display: flex;
      flex-direction: column;
      padding: 20px;
      box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
      position: fixed;
      left: 0;
      top: 0;
    }

    .sidebar h2 {
      margin-bottom: 25px;
      text-align: center;
      font-size: 1.3rem;
      letter-spacing: 1px;
    }

    .sidebar a,
    .sidebar button {
      display: block;
      color: #ecf0f1;
      text-decoration: none;
      background: none;
      border: none;
      text-align: left;
      padding: 12px 15px;
      margin: 5px 0;
      border-radius: 8px;
      transition: background 0.3s;
      cursor: pointer;
      font-size: 15px;
    }

    .sidebar a:hover,
    .sidebar button:hover {
      background: rgba(255, 255, 255, 0.15);
    }

    .main-content {
      margin-left: 250px;
      padding: 30px;
      flex: 1;
    }

    pre {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      white-space: pre-wrap;
      word-wrap: break-word;
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.05);
    }

    textarea {
      width: 100%;
      height: 200px;
      border-radius: 8px;
      border: 1px solid #ccc;
      padding: 10px;
      margin-top: 10px;
      font-family: monospace;
    }

    .top-buttons {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-bottom: 20px;
    }

    .btn {
      background: #2980b9;
      border: none;
      color: white;
      padding: 10px 16px;
      border-radius: 6px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .btn:hover {
      background: #1f6391;
    }

    .btn-danger {
      background: #e74c3c;
    }

    footer {
      text-align: center;
      margin-top: 40px;
      font-size: 0.9rem;
      color: #666;
    }
  </style>
</head>

<body>
  <nav class="sidebar">
    <h2>NoteBridge</h2>
    <a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a>
    <a href="{{ url_for('notebook.view_notebook', notebook_id=note['notebook_id']) }}">Notebook</a>
    <button id="delete-note-btn">Delete Note</button>
    <a href="{{ url_for('auth.logout') }}">Logout</a>
  </nav>

  <div class="main-content">
    <h1>{{ note['title'] }}</h1>

    <div class="top-buttons">
      <button id="save-btn" class="btn">Save</button>
      <button id="dictate-btn" class="btn">Start Dictation</button>
      <button id="read-page-btn" class="btn">Read Page</button>
      <button id="clear-btn" class="btn">Clear</button>
      <button id="voice-assistant-btn" class="btn">Enable Voice Commands</button>
      <button id="stop-voice-btn" class="btn btn-danger">Stop Voice</button>
    </div>

    <article id="note-content">
      <pre>{{ note['content'] }}</pre>
    </article>

    <section>
      <h2>Edit Note</h2>
      <textarea id="editor">{{ note['content'] }}</textarea>
    </section>

    <footer>
      <p>&copy; {{ current_year or 2025 }} NoteBridge</p>
    </footer>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      const noteId = {{ note['id'] | tojson
    }};
    const notebookId = {{ note['notebook_id'] | tojson }};
    const noteTitle = {{ note['title'] | tojson }};

    const editor = document.getElementById('editor');
    const noteContent = document.getElementById('note-content');
    const saveBtn = document.getElementById('save-btn');
    const clearBtn = document.getElementById('clear-btn');
    const deleteBtn = document.getElementById('delete-note-btn');
    const dictateBtn = document.getElementById('dictate-btn');
    const readBtn = document.getElementById('read-page-btn');
    const voiceBtn = document.getElementById('voice-assistant-btn');
    const stopVoiceBtn = document.getElementById('stop-voice-btn');
    const synth = window.speechSynthesis;

    socket.emit('join_note', { note_id: noteId });

    function speak(text) {
      if (!window.speechSynthesis) return;
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'en-US';
      synth.speak(msg);
    }

    // Save
    saveBtn.addEventListener('click', async () => {
      const content = editor.value;
      try {
        const res = await fetch(`/note/${noteId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ title: noteTitle, content })
        });
        if (res.ok) {
          noteContent.innerHTML = `<pre>${content}</pre>`;
          socket.emit('edit', { note_id: noteId, content, title: noteTitle });
          speak("Note saved successfully.");
        } else speak("Failed to save note.");
      } catch (e) { console.error(e); }
    });

    // Clear
    clearBtn.addEventListener('click', () => {
      editor.value = '';
      speak("Note cleared.");
    });

    // Delete
    deleteBtn.addEventListener('click', async () => {
      if (!confirm("Are you sure?")) return;
      const res = await fetch(`/note/${noteId}`, { method: 'DELETE' });
      if (res.ok) {
        speak("Note deleted.");
        window.location.href = `/notebook/${notebookId}`;
      } else speak("Delete failed.");
    });

    // Read Page
    readBtn.addEventListener('click', () => {
      const text = editor.value.trim() || {{ note['content'] | tojson
    }};
    if (!text) return speak("This note is empty.");
    if (synth.speaking) synth.cancel();
    speak(text);
      });

    // Stop Voice
    stopVoiceBtn.addEventListener('click', () => {
      synth.cancel();
      speak("Speech stopped.");
    });

    // Dictation
    let dictating = false;
    let dictation;
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      dictation = new SpeechRecognition();
      dictation.continuous = true;
      dictation.interimResults = false;
      dictation.lang = 'en-US';

      dictateBtn.addEventListener('click', () => {
        if (!dictating) dictation.start();
        else dictation.stop();
      });

      dictation.onstart = () => {
        dictating = true;
        dictateBtn.textContent = "Stop Dictation";
        speak("Dictation started.");
      };
      dictation.onend = () => {
        dictating = false;
        dictateBtn.textContent = "Start Dictation";
        speak("Dictation stopped.");
      };
      dictation.onresult = (event) => {
        for (let i = event.resultIndex; i < event.results.length; i++) {
          if (event.results[i].isFinal) {
            const transcript = event.results[i][0].transcript.trim();
            editor.value += (editor.value ? ' ' : '') + transcript;
            socket.emit('edit', { note_id: noteId, content: editor.value, title: noteTitle });
          }
        }
      };
    }

    // Voice Assistant
    if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
      const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
      const assistant = new SpeechRecognition();
      assistant.continuous = true;
      assistant.interimResults = false;
      assistant.lang = 'en-US';

      assistant.onresult = async (event) => {
        const transcript = Array.from(event.results)
          .map(r => r[0].transcript.toLowerCase().trim())
          .join(' ');

        const normalize = (text) => text
          .replace(/summarise|summerize|summary|summer rise|summery/gi, "summarize")
          .replace(/note\s?book|not book|noot book|note buck/gi, "notebook")
          .trim();

        const fixedTranscript = normalize(transcript);

        if (fixedTranscript.includes("introduction")) speak("Welcome to this note.");
        else if (fixedTranscript.includes("save")) saveBtn.click();
        else if (fixedTranscript.includes("start dictation")) {
          if (!dictating) dictation.start();
          speak("Dictation started.");
        }
        else if (fixedTranscript.includes("read page")) readBtn.click();
        else if (fixedTranscript.includes("clear")) clearBtn.click();
        else if (fixedTranscript.includes("enable voice commands")) speak("Voice assistant enabled.");
        else if (fixedTranscript.includes("stop voice")) {
          window.speechSynthesis.cancel();
          speak("Speech stopped.");
        }
        else if (fixedTranscript.includes("summarize notebook")) {
          speak("Summarizing notebook, please wait.");
          try {
            const res = await fetch(`/notebook/${notebookId}/summarize`);
            const data = await res.json();
            const summary = data.summary || "No summary available.";
            alert("Notebook Summary:\n\n" + summary);
            speak(summary);
          } catch {
            speak("Failed to summarize notebook.");
          }
        }
        else if (fixedTranscript.includes("go back") || fixedTranscript.includes("back to dashboard")) {
          speak("Returning to dashboard.");
          window.location.href = "{{ url_for('dashboard.dashboard') }}";
        }
        else {
          editor.value += ' ' + transcript;
        }
      };

      assistant.onerror = (e) => console.error("Voice assistant error:", e.error);
      assistant.onend = () => assistant.start();
      assistant.start();
    }
    });
  </script>
</body>

</html>