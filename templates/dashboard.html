<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <title>Dashboard - NoteBridge</title>
  <style>
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: 'Poppins', sans-serif;
      background: #f5f7fa;
      color: #1f2937;
      display: flex;
      min-height: 100vh;
    }

    /* -------------------------------
   SIDEBAR
--------------------------------*/
    .sidebar {
      width: 220px;
      background: linear-gradient(180deg, #9e1756, #6366f1);
      color: #fff;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 30px 15px;
      gap: 20px;
    }

    .sidebar img {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #fff;
    }

    .sidebar h2 {
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
    }

    .sidebar a {
      width: 100%;
      padding: 10px 15px;
      margin: 5px 0;
      text-decoration: none;
      font-weight: 500;
      font-size: 0.95rem;
      color: #f3f4f6;
      border-radius: 8px;
      transition: all 0.3s;
    }

    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateX(5px);
    }

    /* -------------------------------
   MAIN CONTENT
--------------------------------*/
    .main-content {
      margin-left: 220px;
      flex: 1;
      padding: 30px;
      display: flex;
      flex-direction: column;
      gap: 25px;
    }

    /* HEADER */
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #fff;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    }

    header .welcome {
      font-size: 1.2rem;
      font-weight: 600;
    }

    /* BUTTONS */
    .btn {
      background: #4f46e5;
      color: #fff;
      padding: 8px 16px;
      border-radius: 8px;
      border: none;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn:hover {
      background: #6366f1;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    /* SECTIONS */
    section {
      background: #fff;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    section:hover {
      transform: translateY(-5px);
      box-shadow: 0 12px 25px rgba(0, 0, 0, 0.08);
    }

    section h2 {
      margin-bottom: 15px;
      font-size: 1.25rem;
      font-weight: 600;
      color: #1f2937;
    }

    /* LIST ITEMS */
    ul {
      list-style: none;
      padding-left: 0;
    }

    li {
      background: #f0f2f5;
      margin-bottom: 12px;
      padding: 12px 16px;
      border-radius: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 0.95rem;
      transition: all 0.3s;
    }

    li:hover {
      background: #e0e7ff;
      transform: scale(1.02);
    }

    /* ACTIVITY LOG */
    #activity-log {
      max-height: 250px;
      overflow-y: auto;
      padding: 12px;
      border-radius: 10px;
      background: #f0f2f5;
    }

    .activity-entry {
      padding: 8px 0;
      border-bottom: 1px solid #d1d5db;
    }

    .activity-entry:last-child {
      border-bottom: none;
    }

    /* FONT SIZES */
    .font-small {
      font-size: 14px;
    }

    .font-medium {
      font-size: 16px;
    }

    .font-large {
      font-size: 18px;
    }

    /* HIGH CONTRAST MODE */
    .high-contrast {
      background: #000;
      color: #fff !important;
    }

    .high-contrast .sidebar {
      background: #000;
    }

    .high-contrast .sidebar a {
      color: #fff;
      background: rgba(255, 255, 255, 0.1);
    }

    .high-contrast section,
    .high-contrast li,
    .high-contrast header {
      background: #111 !important;
      color: #fff !important;
    }

    /* FOOTER */
    footer {
      text-align: center;
      padding: 20px;
      color: #6b7280;
      font-size: 0.9rem;
    }
  </style>

</head>

<body>
  <div class="sidebar" role="navigation" aria-label="Main menu">
    <img src="{{ url_for('static', filename='logo.jpg') }}" alt="User Avatar">
    <h2>{{ user['full_name'] or user['username'] }}</h2>
    <a href="{{ url_for('dashboard.dashboard') }}">Dashboard</a>
    <a href="{{ url_for('notebook.list_notebooks') }}">Notebooks</a>
    <a href="{{ url_for('help.help_page') }}">Help</a>
    <a href="{{ url_for('auth.logout') }}">Logout</a>
  </div>

  <div class="main-content" id="main-content">
    <header>
      <div class="welcome">Welcome, {{ user['full_name'] or user['username'] }}!</div>
      <button class="btn" onclick="readDashboard()">üîä Read Dashboard</button>
    </header>

    <div class="accessibility-controls">
      <label for="font-size">Font size:</label>
      <select id="font-size" onchange="changeFontSize(this.value)">
        <option value="font-small">Small</option>
        <option value="font-medium" selected>Medium</option>
        <option value="font-large">Large</option>
      </select>
      <label for="contrast-toggle">High contrast:</label>
      <input type="checkbox" id="contrast-toggle" onchange="toggleContrast(this.checked)">
      <button onclick="startVoiceRecognition()" class="btn">üéôÔ∏è Voice Commands</button>
      <button onclick="fetchContributions()" class="btn">üìú View Activity</button>
    </div>

    <main id="dashboard-content" role="main">
      <section aria-labelledby="notebooks-section">
        <h2 id="notebooks-section">Your Notebooks</h2>
        <ul id="notebook-list">
          {% for nb in notebooks %}
          <li>
            <a href="{{ url_for('notebook.view_notebook', notebook_id=nb['id']) }}">{{ nb['title'] }}</a>
            <button class="btn"
              onclick="window.location.href='{{ url_for('notebook.view_notebook', notebook_id=nb['id']) }}'">Open</button>
          </li>
          {% else %}
          <li>No notebooks yet.</li>
          {% endfor %}
        </ul>
      </section>

      <section aria-labelledby="groups-section">
        <h2 id="groups-section">Groups</h2>
        <ul>
          {% for g in groups %}
          <li>
            <strong>{{ g['name'] }}</strong> ({{ g['members'] }} members)
            <a href="{{ url_for('group.view_group', group_id=g['id']) }}" class="btn">View</a>
          </li>
          {% else %}
          <li>No groups yet.</li>
          {% endfor %}
        </ul>
      </section>

      <section aria-labelledby="activity-section">
        <h2 id="activity-section">Recent Activity (Accessible Log)</h2>
        <div id="activity-log" role="log" aria-live="polite">
          <p>Loading recent activity...</p>
        </div>
      </section>
    </main>

    <footer>
      <p>&copy; 2025 NoteBridge. All rights reserved.</p>
    </footer>
  </div>

  <script>
    const speech = window.speechSynthesis;
    let rec = null;

    function speak(text) {
      if (speech.speaking || speech.pending) speech.cancel();
      const msg = new SpeechSynthesisUtterance(text);
      msg.lang = 'en-US';
      speech.speak(msg);
    }

    function changeFontSize(size) {
      const c = document.getElementById('main-content');
      c.classList.remove('font-small', 'font-medium', 'font-large');
      c.classList.add(size);
      speak(`Font size changed to ${size.replace('font-', '')}`);
    }

    function toggleContrast(enabled) {
      document.body.classList.toggle('high-contrast', enabled);
      speak(`High contrast ${enabled ? 'enabled' : 'disabled'}`);
    }

    async function fetchContributions() {
      try {
        const res = await fetch('/notebook/contributions');
        const data = await res.json();
        const log = document.getElementById('activity-log');
        log.innerHTML = '';
        if (!data.length) {
          log.innerHTML = '<p>No recent activity.</p>';
          speak("No recent activity found.");
          return;
        }
        data.forEach(entry => {
          const div = document.createElement('div');
          div.classList.add('activity-entry');
          div.innerText = `${entry.timestamp}: ${entry.username} ${entry.action} note "${entry.note_title}"`;
          log.appendChild(div);
        });
        speak(`Loaded ${data.length} recent activities.`);
      } catch (err) {
        console.error(err);
        // speak("Unable to fetch activity log.");
      }
    }

    function readDashboard() {
      const text = document.getElementById('main-content').innerText.trim();
      if (!text) speak("Dashboard is empty.");
      else speak(text);
    }

    function handleCommand(cmd) {
      cmd = cmd.toLowerCase().trim();
      console.log("üé§ Heard voice command:", cmd); // debug log

      // Number word mapping
      const words = { one: 1, two: 2, three: 3, four: 4, five: 5, six: 6, seven: 7, eight: 8, nine: 9, ten: 10 };
      for (const w in words) cmd = cmd.replace(`notebook ${w}`, `notebook ${words[w]}`);

      // --- Navigation Commands ---
      if (cmd.includes('dashboard') || cmd.includes('go back')) {
        console.log("‚û°Ô∏è Voice command: Go to dashboard");
        window.location.href = '{{ url_for("dashboard.dashboard") }}';
        return;
      }

      // --- Create Notebook Commands ---
      if (cmd.match(/(create|make|start)(.*)(notebook)/)) {
        console.log("üÜï Voice command: Create Notebook detected");
        speak("Opening notebook creation page.");
        window.location.href = '/notebook/create';
        return;
      }

      // --- Open Notebook X ---
      const openMatch = cmd.match(/open notebook (\d+)/);
      if (openMatch) {
        const nb = parseInt(openMatch[1]);
        console.log(`üìñ Voice command: Open notebook #${nb}`);
        const links = document.querySelectorAll('#notebook-list li a');
        if (links[nb - 1]) {
          speak(`Opening notebook number ${nb}`);
          window.location.href = links[nb - 1].href;
        } else {
          speak("Notebook not found.");
        }
        return;
      }

      // --- View Groups ---
      if (cmd.includes('view groups') || cmd.includes('open groups')) {
        console.log("üë• Voice command: View Groups");
        speak("Opening groups page.");
        window.location.href = '/groups';
        return;
      }

      // --- Read Activity ---
      if (cmd.includes('read activity')) {
        console.log("üìú Voice command: Read Activity Log");
        fetchContributions();
        return;
      }

      // --- Read Dashboard ---
      if (cmd.includes('read dashboard')) {
        console.log("üì¢ Voice command: Read Dashboard");
        readDashboard();
        return;
      }

      // --- Font Controls ---
      if (cmd.includes('increase font') || cmd.includes('large text')) {
        console.log("üî† Voice command: Increase Font");
        changeFontSize('font-large');
        return;
      }

      if (cmd.includes('decrease font') || cmd.includes('small text')) {
        console.log("üî° Voice command: Decrease Font");
        changeFontSize('font-small');
        return;
      }

      if (cmd.includes('normal font')) {
        console.log("üî§ Voice command: Normal Font");
        changeFontSize('font-medium');
        return;
      }

      // --- High Contrast ---
      if (cmd.includes('enable high contrast')) {
        console.log("üåó Voice command: Enable High Contrast");
        document.getElementById('contrast-toggle').checked = true;
        toggleContrast(true);
        return;
      }

      if (cmd.includes('disable high contrast')) {
        console.log("üåñ Voice command: Disable High Contrast");
        document.getElementById('contrast-toggle').checked = false;
        toggleContrast(false);
        return;
      }

      // --- Open Help Page using voice command---
      if (cmd.includes('help page') || cmd === 'help' || cmd.includes('open help')) {
        console.log("üÜò Voice command: Open Help Page");
        speak("Opening the Help page.");
        window.location.href = '{{ url_for("help.help_page") }}';
        return;
      }

      // --- Logout ---
      if (cmd.includes('logout') || cmd.includes('log out')) {
        console.log("üö™ Voice command: Logout");
        speak("Logging out.");
        window.location.href = '{{ url_for("auth.logout") }}';
        return;
      }
      // --- Open Chatbot Page ---
      if (cmd.includes('chatbot') || cmd.includes('open chatbot') || cmd.includes('go to chatbot')) {
        console.log("üí¨ Voice command: Open Chatbot Page");
        speak("Opening chatbot page.");
        window.location.href = '/chatbot';
        return;
      }


      console.log("‚ùì No matching voice command for:", cmd);
    }
    // --- Voice Recognition Setup ---
    function startVoiceRecognition() {
      if (!('webkitSpeechRecognition' in window)) {
        alert("Please use Google Chrome for full voice support.");
        return;
      }
      if (rec) { rec.stop(); rec = null; }
      rec = new webkitSpeechRecognition();
      rec.lang = 'en-US';
      rec.continuous = true;
      rec.interimResults = false;
      rec.onresult = e => {
        const t = e.results[e.results.length - 1][0].transcript;
        handleCommand(t);
      };
      rec.onerror = e => console.error("Speech error:", e.error);
      rec.onend = () => setTimeout(startVoiceRecognition, 2000);
      rec.start();
      // speak("Voice command mode activated. Say 'read dashboard' or 'create notebook'.");
    }
    window.addEventListener('DOMContentLoaded', () => {
      fetchContributions();
      startVoiceRecognition();
    });
  </script>
</body>

</html>